<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.css.app.qxjgl.business.dao.LeaveorbackDao">

	<select id="queryObject" resultType="com.css.app.qxjgl.business.entity.Leaveorback">
		select * from QXJ_LEAVEORBACK where ID = #{value}
	</select>

	<select id="queryRealRestDays" resultType="int">
		select IFNULL(sum (DECODE(ACTUAL_VOCATION_DATE, NULL , LEAVE_DAYS, ACTUAL_VOCATION_DATE)), 0) realRestDays from QXJ_LEAVEORBACK where DELETE_MARK like '%' || #{userId} || '%' and status = '30'
	</select>

	<select id="queryCurrYearRestDays" resultType="com.css.app.qxjgl.business.entity.Leaveorback">
		select * from (
		select
			IFNULL(DECODE(ACTUAL_VOCATION_DATE, NULL , LEAVE_DAYS, ACTUAL_VOCATION_DATE), 0) REST_DAYS,
			IFNULL(ACTUAL_TIME_START, PLAN_TIME_START)  START_TIME,
			IFNULL(ACTUAL_TIME_END, PLAN_TIME_END) END_TIME
		from QXJ_LEAVEORBACK
		where
				DELETE_MARK like '%' || #{userId} || '%'
		and status = '30'
		)
		where
		   <![CDATA[
	    	END_TIME >= to_date(#{newYearStartDate},'yyyy-mm-dd')
	    	and START_TIME <= to_date(#{newYearEndDate},'yyyy-mm-dd')]]>
	</select>
	
	<select id="queryNewList" resultType="com.css.app.qxjgl.business.entity.Leaveorback">
		select a.*,b.deal_user_id,b.deal_user_name,b.flow_type,c.receiver_is_me from QXJ_LEAVEORBACK a
		<!-- 登录人为流经人，请销假审批菜单查询 -->
		<if test="flowPeople != null and flowPeople != ''">
			inner join(select leave_id from (select leave_id, row_number() over(partition by leave_id order by create_date desc) as num
			from QXJ_APPROVAL_FLOW where approval_id = #{loginUserId})where num =1)as d on a.ID = d.leave_id
		</if>
		<!-- 当前处理人 -->
		left join (select leave_id,approval_id as deal_user_id, approval_name as deal_user_name,flow_type from (select leave_id,approval_id,approval_name,flow_type,row_number() over(partition by leave_id order by create_date desc) as num from QXJ_APPROVAL_FLOW) where num=1) b on a.id=b.leave_id
		<!-- receiverIsMe：1我为当前处理人 -->
		left join (select leave_id,1 as receiver_is_me from
		(select leave_id,approval_id,row_number() over(partition by leave_id order by create_date desc) as num from QXJ_APPROVAL_FLOW) where num = 1
		<if test="loginUserId !=null and loginUserId !=''">
			and approval_id = #{loginUserId}
		</if>)as c on a.ID = c.leave_id where 1=1
		<!-- 创建人 ，请销假审批菜单查询 -->
		<if test="creatorId != null">
			and a.creator_id = #{creatorId}
		</if>
		<!--    申请日期开始时间      搜索栏  -->
		<if test="sqrqFrom != null">
			and a.APPLICATION_DATE >= #{sqrqFrom}
		</if>
		<!--      申请日期结束时间      搜索栏  -->		
		<if test="sqrqTo != null">
			and a.APPLICATION_DATE &lt;= #{sqrqTo}
		</if>
		<!--        休假类别      	      搜索栏  -->
		<if test="xjlb != null">
			and a.VACATION_SORT_ID = #{xjlb}
		</if>
		<!--  申请人 -->		
		<if test="sqrName != null ">
			and a.PROPOSER like '%'||#{sqrName}||'%'
		</if>
		<!--  状态 -->
		<if test="status != null ">
			and a.status = #{status}
		</if>
		<!-- 请假时间 -->
		<if test="planTimeStart != null and planTimeEnd != null">
			and ((a.PLAN_TIME_START >= #{planTimeStart} and a.PLAN_TIME_END &lt;= #{planTimeEnd}) or
			(a.PLAN_TIME_START &lt;= #{planTimeStart} and a.PLAN_TIME_END >= #{planTimeStart} and a.PLAN_TIME_END &lt;= #{planTimeEnd}) or
			(a.PLAN_TIME_START >= #{planTimeStart} and a.PLAN_TIME_START &lt;= #{planTimeEnd} and a.PLAN_TIME_END >= #{planTimeEnd}) or
			(a.PLAN_TIME_START &lt;= #{planTimeStart} and a.PLAN_TIME_END >= #{planTimeEnd}))
		</if>
		<!-- 销假状态 -->
		<if test="xjzt != null and xjzt != ''">
            <choose>
                <when test="xjzt == 0">
                    and (a.BACK_STATUS_ID = #{xjzt} OR  a.BACK_STATUS_ID IS NULL OR a.BACK_STATUS_ID = '')
                </when>
                <otherwise>
                    and  a.BACK_STATUS_ID = #{xjzt}
                </otherwise>
            </choose>
		</if>
		<!-- 登录人为流经人，请销假审批菜单查询 查询已提交的和退回给起草人的-->
		<if test="flowPeople != null and flowPeople != ''">
			and a.status  != '0' and a.creator_id != #{loginUserId}
		</if>
		<if test="receiverIsMe != null and receiverIsMe != ''">
			<choose>
                <when test="receiverIsMe == 'yes'">
                    and c.receiver_is_me=1
                </when>
                <when test="receiverIsMe == 'no'">
                    and (c.receiver_is_me !=1 or c.receiver_is_me is null
                    <choose>
						<when test="status != 10">
							or c.receiver_is_me = 1
						</when>
					</choose>)
                </when>
            </choose>
		</if>
		order by a.status asc,c.receiver_is_me nulls last,a.APPLICATION_DATE desc
		<if test="offset != null and limit != null">
			limit #{offset}, #{limit}
		</if>			
	</select>
	<select id="queryNewList1" resultType="com.css.app.qxjgl.business.entity.Leaveorback">
		select a.*,b.deal_user_id,b.deal_user_name,b.flow_type,c.receiver_is_me,ROW_NUMBER() OVER(order by a.STATUS asc, a.CREATE_DATE desc ) as sort from QXJ_LEAVEORBACK a
		<!-- 登录人为流经人，请销假审批菜单查询 -->
		<if test="flowPeople != null and flowPeople != ''">
			inner join(select leave_id from (select leave_id, row_number() over(partition by leave_id order by create_date desc) as num
			from QXJ_APPROVAL_FLOW where approval_id = #{loginUserId})where num =1)as d on a.ID = d.leave_id
		</if>
		<!-- 当前处理人 -->
		left join (select leave_id,approval_id as deal_user_id, approval_name as deal_user_name,flow_type from (select leave_id,approval_id,approval_name,flow_type,row_number() over(partition by leave_id order by create_date desc) as num from QXJ_APPROVAL_FLOW) where num=1) b on a.id=b.leave_id
		<!-- receiverIsMe：1我为当前处理人 -->
		left join (select leave_id,1 as receiver_is_me from
		(select leave_id,approval_id,row_number() over(partition by leave_id order by create_date desc) as num from QXJ_APPROVAL_FLOW) where num = 1
		<if test="loginUserId !=null and loginUserId !=''">
			and approval_id = #{loginUserId}
		</if>)as c on a.ID = c.leave_id where 1=1
		<!-- 创建人 ，请销假审批菜单查询 -->
		<if test="creatorId != null">
			and a.creator_id = #{creatorId}
		</if>
		<!--    申请日期开始时间      搜索栏  -->
		<if test="sqrqFrom != null">
			and a.APPLICATION_DATE >= #{sqrqFrom}
		</if>
		<!--      申请日期结束时间      搜索栏  -->
		<if test="sqrqTo != null">
			and a.APPLICATION_DATE &lt;= #{sqrqTo}
		</if>
		<!--        休假类别      	      搜索栏  -->
		<if test="xjlb != null">
			and a.VACATION_SORT_ID = #{xjlb}
		</if>
		<!--  申请人 -->
		<if test="sqrName != null ">
			and a.PROPOSER like '%'||#{sqrName}||'%'
		</if>
		<!--  状态 -->
		<if test="status != null ">
			and a.status = #{status}
		</if>
		<if test="receiverIsMe != null">
			and a.receiverIsMe = #{receiverIsMe}
		</if>
		<if test="flowType != null">
			and a.flowType = #{flowType}
		</if>
		<!-- 请假时间 -->
		<if test="planTimeStart != null and planTimeEnd != null">
			and ((a.PLAN_TIME_START >= #{planTimeStart} and a.PLAN_TIME_END &lt;= #{planTimeEnd}) or
			(a.PLAN_TIME_START &lt;= #{planTimeStart} and a.PLAN_TIME_END >= #{planTimeStart} and a.PLAN_TIME_END &lt;= #{planTimeEnd}) or
			(a.PLAN_TIME_START >= #{planTimeStart} and a.PLAN_TIME_START &lt;= #{planTimeEnd} and a.PLAN_TIME_END >= #{planTimeEnd}) or
			(a.PLAN_TIME_START &lt;= #{planTimeStart} and a.PLAN_TIME_END >= #{planTimeEnd}))
		</if>
		<!-- 销假状态 -->
		<if test="xjzt != null and xjzt != ''">
			<choose>
				<when test="xjzt == 0">
					and (a.BACK_STATUS_ID = #{xjzt} OR  a.BACK_STATUS_ID IS NULL OR a.BACK_STATUS_ID = '')
				</when>
				<otherwise>
					and  a.BACK_STATUS_ID = #{xjzt}
				</otherwise>
			</choose>
		</if>
		<!-- 登录人为流经人，请销假审批菜单查询 查询已提交的和退回给起草人的-->
		<if test="flowPeople != null and flowPeople != ''">
			and a.status  != '0' and a.creator_id != #{loginUserId}
		</if>
		<if test="receiverIsMe != null and receiverIsMe != ''">
			<choose>
				<when test="receiverIsMe == 'yes'">
					and c.receiver_is_me=1
				</when>
				<when test="receiverIsMe == 'no'">
					and (c.receiver_is_me !=1 or c.receiver_is_me is null
					<choose>
						<when test="status != 10">
							or c.receiver_is_me = 1
						</when>
					</choose>)
				</when>
			</choose>
		</if>
		order by a.status asc,c.receiver_is_me nulls last,a.APPLICATION_DATE desc
		<if test="offset != null and limit != null">
			limit #{offset}, #{limit}
		</if>
	</select>
	<select id="queryQjCompletedUser" resultType="com.css.app.qxjgl.business.entity.Leaveorback">
		select distinct delete_mark, proposer from QXJ_LEAVEORBACK where status = '2' and (back_status_id is null or back_status_id != '1')
		<if test="leaveIds != null and leaveIds.length >0">
			and delete_mark not in
			<foreach item="item" collection="leaveIds" open="(" separator="," close=")">
			#{item}</foreach>
			</if>
			<if test="data != null and data != null">
			and PLAN_TIME_END &gt;= to_date(#{data},'yyyy-mm-dd') and PLAN_TIME_START &lt;= to_date(#{data},'yyyy-mm-dd')
			</if>
	</select>

	<select id="queryQjCompletedUserByOrgid" resultType="int">
	select ifnull(count(*),0) from (
			select  distinct ql.delete_mark from QXJ_LEAVEORBACK ql 
			inner join BASE_APP_USER ba on ql.delete_mark=ba.user_id  
			where ql.status = '2' and (ql.back_status_id is null or ql.back_status_id != '1')
			
			and ba.ORGANID in (select ID from BASE_APP_ORGAN where ISDELETE = 0 and TREE_PATH like '%'||#{orgid}||'%')
			
			<if test="leaveIds != null and leaveIds.length >0">
			and ql.delete_mark not in
			<foreach item="item" collection="leaveIds" open="(" separator="," close=")">
			#{item}</foreach>
			</if>
			<if test="data != null and data != null">
			and ql.PLAN_TIME_END &gt;= to_date(#{data},'yyyy-mm-dd') and ql.PLAN_TIME_START &lt;= to_date(#{data},'yyyy-mm-dd')
			</if>
		)
	</select>
	<select id="queryQjCompletedUserByOrgid2" resultType="com.css.app.qxjgl.business.entity.Leaveorback">
		select o.tree_path as delete_mark from BASE_APP_ORGAN o right join
		BASE_APP_USER u on o.id=u.ORGANID and o.ISDELETE = 0
		right join
		(
				select distinct delete_mark from QXJ_LEAVEORBACK where status = '2' and (back_status_id is null or back_status_id != '1')
		<if test="leaveIds != null and leaveIds.length >0">
			and delete_mark not in
			<foreach item="item" collection="leaveIds" open="(" separator="," close=")">
			#{item}</foreach>
			</if>
			<if test="data != null and data != null">
			and PLAN_TIME_END &gt;= to_date(#{data},'yyyy-mm-dd') and PLAN_TIME_START &lt;= to_date(#{data},'yyyy-mm-dd')
			</if>
			
		) q on u.USER_ID=q.delete_mark
	</select>


	<select id="queryList" resultType="com.css.app.qxjgl.business.entity.Leaveorback">
		select * from QXJ_LEAVEORBACK 
		where
		1=1	
			<if test="man != null"><!--    请假天数  -->
				and DELETE_MARK = #{man}
			</if>
			
			<if test="sqrqFrom != null"><!--    申请日期开始时间      搜索栏  -->
				and APPLICATION_DATE >= #{sqrqFrom}
			</if>
			
			<if test="viewRemark != null"><!--    申请日期开始时间      搜索栏  -->
				and VIEW_REMARK = #{viewRemark}
			</if>
			<if test="sqrqTo != null"><!--      申请日期结束时间      搜索栏  -->
				and APPLICATION_DATE &lt;= #{sqrqTo}
			</if>
			<if test="xjlb != null"><!--        休假类别      	      搜索栏  -->
				and VACATION_SORT_ID = #{xjlb}
			</if>
			<if test="sqrId != null "><!--       申请人id        搜索栏  -->
				and PROPOSER like #{sqrId}
			</if>
			<!-- <if test="leaveStatus != null ">      处长登陆时要去除掉普通用户仅仅保存而不是提交的记录 
				and LEAVE_STATUS_ID != #{leaveStatus}
			</if> -->
			<if test="deleteMark != null">     <!-- 登陆人id         登陆的普通员工或者需要请假的处长列表所需条件 --> 
				and DELETE_MARK = #{deleteMark}
			</if>
			<if test="leaderId != null">        <!-- 处长id     		处长页面列表所需条件     	map.put("viewRemark", "3");//局长不通过，处长通过。可见 -->
				and LEADER_ID = #{leaderId}
				and (LEAVE_STATUS_ID != '3' or VIEW_REMARK = '3')
			</if>
			<if test="chairmanId != null">      <!-- 局长id 			局长页面列表所需条件 -->
				and CHAIRMAN_ID = #{chairmanId}
			</if>
			<if test="status != null and status.length >0">
			and status in
			<foreach item="item" collection="status" open="(" separator="," close=")">
			#{item}
			</foreach>
			</if>
			<if test="leaveIds != null and leaveIds.length >0">
			and id in
			<foreach item="item" collection="leaveIds" open="(" separator="," close=")">
			#{item}</foreach>
			</if>
			<if test="starday != null and endday != null">
				and (
				(PLAN_TIME_END &gt;= to_date(#{starday},'yyyy-mm-dd') and PLAN_TIME_START &lt;= to_date(#{starday},'yyyy-mm-dd'))
				or
				(PLAN_TIME_END &gt;= to_date(#{endday},'yyyy-mm-dd') and PLAN_TIME_START &lt;= to_date(#{endday},'yyyy-mm-dd'))
				)
			</if>
			<if test="data != null and data != null">
			and PLAN_TIME_END &gt;= to_date(#{data},'yyyy-mm-dd') and PLAN_TIME_START &lt;= to_date(#{data},'yyyy-mm-dd')
			</if>
											<!-- 现系统，以下三个条件是各自独立的，三选其一-->
											<!--请销假 首页 排序   上下 三角号   sortname 是 排序字段  sorttype是 排序 类型  -->
			<!-- <if test="sortname != null  and sorttype != null">      
				order by  APPLICATION_DATE  ${sorttype}   
			</if>	 -->
				order by  APPLICATION_DATE  desc,create_date desc
		<if test="offset != null and limit != null">
			limit #{offset}, #{limit}
		</if>
			
	</select>
	
<!-- 		<select id="queryQXJList" resultType="com.css.app.qxjgl.leaveorback.entity.TLeaveorback"> -->
<!-- 		select k.*,y.shouldTakDays shouldTakDays from QXJ_LEAVEORBACK k left join qxj_dic_holiday y on k.DELETE_MARK=y.USERID -->
		
<!-- 			where proposer='鲁参谋' -->			
<!-- 	</select> -->
   <!-- <select id="queryQXJList" resultType="com.css.app.qxjgl.leaveorback.entity.TLeaveorback">
        select k.* from (
        select
            z.ID ID,
            z.PROPOSER PROPOSER,
            y.shouldTakDays shouldTakDays,
            z. VACATION_SORT_ID VACATION_SORT_ID ,
            z.LEAVE_DAYS  LEAVE_DAYS,
            z.PLAN_TIME_START PLAN_TIME_START,
            z.PLAN_TIME_END PLAN_TIME_END,
            z.BACK_STATUS_ID BACK_STATUS_ID,
            z.org_id detp_id,
            z.PARENT_ORG_ID org_id,
            z.weekendNum weekendNum,
            z.holidayNum holidayNum,
            z.status status,
            z.APPLICATION_DATE APPLICATION_DATE,
            z.create_date create_date,
            z.DELETE_MARK DELETE_MARK,
            z.org_name org_name,
            z.ACTUAL_VOCATION_DATE  ACTUAL_VOCATION_DATE
        from QXJ_LEAVEORBACK z
        left join QXJ_DIC_HOLIDAY y on
        z.DELETE_MARK=y.USERID
        union
		select
		z.ID ID,
		x.APPLY_USER_NAME PROPOSER,
		y.shouldTakDays shouldTakDays,
		z. VACATION_SORT_ID VACATION_SORT_ID ,
		z.LEAVE_DAYS  LEAVE_DAYS,
		z.PLAN_TIME_START PLAN_TIME_START,
		z.PLAN_TIME_END PLAN_TIME_END,
		z.BACK_STATUS_ID BACK_STATUS_ID,
		x.APPLY_DEPT_ID dept_id,
		x.APPLY_ORG_ID org_id,
		z.weekendNum weekendNum,
		z.holidayNum holidayNum,
		z.status status,
		z.APPLICATION_DATE APPLICATION_DATE,
		z.create_date create_date,
		x.APPLY_USER_ID DELETE_MARK,
		x.APPLY_DEPT_NAME org_name,
		z.ACTUAL_VOCATION_DATE  ACTUAL_VOCATION_DATE
		from QXJ_LEAVEORBACK z, QXJ_APPLY_USER x,QXJ_DIC_HOLIDAY y
		where z.ID = x.LEAVE_ID and x.APPLY_USER_ID = y.USERID
		) k
        where 1=1
        /*看局内数据*/
        <choose>
            <when test="orgIdOrDeptId != null and orgIdOrDeptId !='' ">
                and (k.org_id = #{orgIdOrDeptId} or k.detp_id = #{orgIdOrDeptId})
            </when>
            <otherwise>
                /*看处内数据*/
                <if test="deptId != null and deptId !=''">&lt;!&ndash;过滤级别权限数据 &ndash;&gt;
                    and k.detp_id  = #{deptId}
                </if>
                /*看局内数据*/
                <if test="orgId != null and orgId !=''">&lt;!&ndash;过滤级别权限数据 &ndash;&gt;
                    and k.org_id = #{orgId}
                </if>
            </otherwise>
        </choose>

        <if test="sqrId != null and sqrId !=''">
            and k.DELETE_MARK = #{sqrId}
        </if>

        <if test="status != null and status !=''">
            and k.status = #{status}
        </if>

        <if test="backStatusId != null and backStatusId !=''">
            <choose>
                <when test="backStatusId == '0'">
                    and k.back_Status_Id  = #{backStatusId} or k.back_Status_Id is null or k.back_Status_Id = ''
                </when>
                <otherwise>
                    and k.back_Status_Id  = #{backStatusId}
                </otherwise>
            </choose>
        </if>

        <if test="planTimeStart != null and planTimeStart !=''">
            and k.PLAN_TIME_START &gt;= to_date(#{planTimeStart},'yyyy-mm-dd')
        </if>

        <if test="plantTimeEnd != null and plantTimeEnd !=''">
            and k.PLAN_TIME_END &lt;= to_date(#{plantTimeEnd},'yyyy-mm-dd')
        </if>

        <if test="statusForQuery == 3">
            and ((k.status=10 and k.leave_Status_Id=1) or (k.back_Status_Id != 1 and k.status = 30))
        </if>
        <if test="statusForQuery == 4">
            and ((k.status=10 and k.back_Status_Id=1) or k.back_Status_Id=1)
        </if>
        <if test="statusForQuery == 5">
            and (k.back_Status_Id = 1 or (k.back_Status_Id != 1 and k.status = 30))
        </if>
        <if test="statusForQuery == 6">
            and (k.status=10 or k.status=20)
        </if>
        order by k.APPLICATION_DATE desc,k.create_date desc
        <if test="offset != null and limit != null">
            limit #{offset}, #{limit}
        </if>

    </select>-->
		<select id="queryQXJList" resultType="com.css.app.qxjgl.business.entity.Leaveorback">
		select * from (
		select
			z.ID ID,
			x.APPLY_USER_NAME PROPOSER,
			IFNULL(y.shouldTakDays, 0) shouldTakDays,
			z. VACATION_SORT_ID VACATION_SORT_ID ,
			z.LEAVE_DAYS  LEAVE_DAYS,
			z.PLAN_TIME_START PLAN_TIME_START,
			z.PLAN_TIME_END PLAN_TIME_END,
			z.ACTUAL_TIME_START ACTUAL_TIME_START,
			z. ACTUAL_TIME_END ACTUAL_TIME_END,
			z.BACK_STATUS_ID BACK_STATUS_ID,
			x.APPLY_DEPT_ID dept_id,
			x.APPLY_ORG_ID org_id,
			z.weekendNum weekendNum,
			z.holidayNum holidayNum,
			z.status status,
			z.APPLICATION_DATE APPLICATION_DATE,
			z.create_date create_date,
			x.APPLY_USER_ID DELETE_MARK,
			x.APPLY_DEPT_NAME org_name,
			z.place place,
            z.origin origin,
			z.ACTUAL_VOCATION_DATE  ACTUAL_VOCATION_DATE
		from QXJ_LEAVEORBACK z
		left join QXJ_APPLY_USER x on x.LEAVE_ID = z.ID  and z.DELETE_MARK like '%' || x.APPLY_USER_ID || '%'
		left join QXJ_DIC_HOLIDAY y on x.APPLY_USER_ID = y.USERID
		) k
		where 1=1
			/*看处内数据*/
			<if test="deptId != null and deptId !=''">
				and k.dept_id  in
				<foreach collection="deptId" item="item" index="index" open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			/*看局内数据*/
			<if test="deptIdOrg != null and deptIdOrg !=''">
				and k.dept_id = #{deptIdOrg}
			</if>

			<if test="sqrId != null and sqrId !=''">
				and k.DELETE_MARK = #{sqrId}
			</if>

			<if test="status != null and status !=''">
				and k.status = #{status}
			</if>
			<if test="xjlb != null and xjlb !=''">
				and k.VACATION_SORT_ID = #{xjlb}
			</if>
			
			<if test="backStatusId != null and backStatusId !=''">
				<choose>
					<when test="backStatusId == '0'">
						and k.back_Status_Id  = #{backStatusId} or k.back_Status_Id is null or k.back_Status_Id = ''
					</when>
					<otherwise>
						and k.back_Status_Id  = #{backStatusId}
					</otherwise>
				</choose>
			</if>
			<if test="planTimeStart != null and planTimeStart !='' and planTimeEnd != null and planTimeEnd !=''">
				and
				(
					(IFNULL(k.ACTUAL_TIME_START, k.PLAN_TIME_START) between to_date(#{planTimeStart},'yyyy-mm-dd') and  to_date(#{planTimeEnd},'yyyy-mm-dd'))
					or
					(IFNULL(k.ACTUAL_TIME_START, k.PLAN_TIME_START) &lt;= to_date(#{planTimeStart},'yyyy-mm-dd') and IFNULL(k.ACTUAL_TIME_END, k.PLAN_TIME_END) >= to_date(#{planTimeEnd},'yyyy-mm-dd'))
					or
					(IFNULL(k.ACTUAL_TIME_END,  k.PLAN_TIME_END) between to_date(#{planTimeStart},'yyyy-mm-dd') and to_date(#{planTimeEnd},'yyyy-mm-dd'))
				)
			</if>

			<!--<if test="plantTimeEnd != null and plantTimeEnd !=''">
				and k.PLAN_TIME_END &lt;= to_date(#{plantTimeEnd},'yyyy-mm-dd')
			</if>-->
			<!--<if test="dates != null and dates.size > 0">
				and
				<foreach collection="dates" item="item" index="index" open="(" separator="," close=")">
 				   /* and k.PLAN_TIME_START >= to_date(#{item}, 'yyyy-mm-dd') and to_date(#{item}, 'yyyy-mm-dd') >= k.PLAN_TIME_END*/
					#{item} between k.PLAN_TIME_START and k.PLAN_TIME_END
				</foreach>
			</if>-->
			<if test="statusForQuery == 3">
				and ((k.status=10 or k.status=20) or (k.back_Status_Id != 1 and k.status = 30))
			</if>
			<if test="statusForQuery == 4">
				and (k.status=10 or k.status=20 or k.back_Status_Id=1)
			</if>
			<if test="statusForQuery == 5">
				and (k.back_Status_Id = 1 or (k.back_Status_Id != 1 and k.status = 30))
			</if>
			<if test="statusForQuery == 6">
				and (k.status=10 or k.status=20)
			</if>
			order by k.APPLICATION_DATE desc,k.create_date desc
			<if test="offset != null and limit != null">
				limit #{offset}, #{limit}
			</if>
	</select>
	
	<!--<select id="queryQJList1" resultType="com.css.app.qxjgl.leaveorback.entity.TLeaveorback">
		select * from QXJ_LEAVEORBACK 
		where
		1=1	
			<if test="man != null">&lt;!&ndash;    请假天数  &ndash;&gt;
				and DELETE_MARK = #{man}
			</if>
			
			<if test="sqrqFrom != null">&lt;!&ndash;    申请日期开始时间      搜索栏  &ndash;&gt;
				and APPLICATION_DATE >= #{sqrqFrom}
			</if>
			
			<if test="viewRemark != null">&lt;!&ndash;    申请日期开始时间      搜索栏  &ndash;&gt;
				and VIEW_REMARK = #{viewRemark}
			</if>
			<if test="sqrqTo != null">&lt;!&ndash;      申请日期结束时间      搜索栏  &ndash;&gt;
				and APPLICATION_DATE &lt;= #{sqrqTo}
			</if>
			<if test="xjlb != null">&lt;!&ndash;        休假类别      	      搜索栏  &ndash;&gt;
				and VACATION_SORT_ID = #{xjlb}
			</if>
			<if test="sqrId != null ">&lt;!&ndash;       申请人id        搜索栏  &ndash;&gt;
				and PROPOSER = #{sqrId}
			</if>
			&lt;!&ndash; <if test="leaveStatus != null ">      处长登陆时要去除掉普通用户仅仅保存而不是提交的记录
				and LEAVE_STATUS_ID != #{leaveStatus}
			</if> &ndash;&gt;
			<if test="deleteMark != null">     &lt;!&ndash; 登陆人id         登陆的普通员工或者需要请假的处长列表所需条件 &ndash;&gt;
				and DELETE_MARK = #{deleteMark}
			</if>
			<if test="leaderId != null">        &lt;!&ndash; 处长id     		处长页面列表所需条件     	map.put("viewRemark", "3");//局长不通过，处长通过。可见 &ndash;&gt;
				and LEADER_ID = #{leaderId}
			</if>
			<if test="chairmanId != null">      &lt;!&ndash; 局长id 			局长页面列表所需条件 &ndash;&gt;
				and CHAIRMAN_ID = #{chairmanId}
			</if>
			<if test="status != null and status.length >0">
			and status in
			<foreach item="item" collection="status" open="(" separator="," close=")">
			#{item}
			</foreach>
			</if>
			<if test="leaveIds != null and leaveIds.length >0">
			and id in
			<foreach item="item" collection="leaveIds" open="(" separator="," close=")">
			#{item}</foreach>
			</if>
			<if test="starday != null and endday != null">
				and (
				(PLAN_TIME_END &gt;= to_date(#{starday},'yyyy-mm-dd') and PLAN_TIME_START &lt;= to_date(#{starday},'yyyy-mm-dd'))
				or
				(PLAN_TIME_END &gt;= to_date(#{endday},'yyyy-mm-dd') and PLAN_TIME_START &lt;= to_date(#{endday},'yyyy-mm-dd'))
				)
			</if>
			<if test="data != null and data != null">
			and PLAN_TIME_END &gt;= to_date(#{data},'yyyy-mm-dd') and PLAN_TIME_START &lt;= to_date(#{data},'yyyy-mm-dd')
			</if>
											&lt;!&ndash; 现系统，以下三个条件是各自独立的，三选其一&ndash;&gt;
											&lt;!&ndash;请销假 首页 排序   上下 三角号   sortname 是 排序字段  sorttype是 排序 类型  &ndash;&gt;
			&lt;!&ndash; <if test="sortname != null  and sorttype != null">
				order by  APPLICATION_DATE  ${sorttype}   
			</if>	 &ndash;&gt;
				order by  APPLICATION_DATE  desc,create_date desc
		<if test="offset != null and limit != null">
			limit #{offset}, #{limit}
		</if>
			
	</select>-->
	
 	<select id="queryTotal" resultType="int">
		select count(0) from QXJ_LEAVEORBACK
		where 1=1
			<if test="man != null"><!--    请假天数  -->
				and DELETE_MARK = #{man}
			</if>
			
			<if test="sqrqFrom != null"><!--    申请日期开始时间      搜索栏  -->
				and APPLICATION_DATE >= #{sqrqFrom}
			</if>
			
			<if test="viewRemark != null"><!--    申请日期开始时间      搜索栏  -->
				and VIEW_REMARK = #{viewRemark}
			</if>
			<if test="sqrqTo != null"><!--      申请日期结束时间      搜索栏  -->
				and APPLICATION_DATE &lt;= #{sqrqTo}
			</if>
			<if test="xjlb != null"><!--        休假类别      	      搜索栏  -->
				and VACATION_SORT_ID = #{xjlb}
			</if>
			<if test="sqrId != null "><!--       申请人id        搜索栏  -->
				and PROPOSER like #{sqrId}
			</if>
			<if test="proposer != null "><!--       申请人  -->
				and PROPOSER like #{proposer}
			</if>
			<if test="keywords != null and keywords.length>0">
			and 
			<foreach collection="keywords" item="item" open="(" separator="or" close=")">
			CHAIRMAN_VIEW like '%'||#{item}||'%'
			or LEADER_LEAVE_VIEW like '%'||#{item}||'%'
			or LEADER_BACK_VIEW like '%'||#{item}||'%'
			or VIEW_REMARK like '%'||#{item}||'%'
			or VOCATION_PLACE like '%'||#{item}||'%'
			<if test="zm != null">
			or UCASE(GETPY(CHAIRMAN_VIEW)) like '%'|| UCASE(GETPY(#{item}))||'%'
			or UCASE(GETPY(LEADER_LEAVE_VIEW)) like '%'|| UCASE(GETPY(#{item}))||'%'
			or UCASE(GETPY( LEADER_BACK_VIEW)) like '%'|| UCASE(GETPY(#{item}))||'%'
			or UCASE(GETPY( VIEW_REMARK)) like '%'|| UCASE(GETPY(#{item}))||'%'
			or UCASE(GETPY(VOCATION_PLACE)) like '%'|| UCASE(GETPY(#{item}))||'%'
			</if>
			</foreach>
			</if>
			<if test="leaveStatus != null "><!--       处长登陆时要去除掉普通用户仅仅保存而不是提交的记录  -->
				and LEAVE_STATUS_ID != #{leaveStatus}
			</if>
			<if test="deleteMark != null">     <!-- 登陆人id         登陆的普通员工或者需要请假的处长列表所需条件 --> 
				and DELETE_MARK = #{deleteMark}
			</if>
			<if test="leaderId != null">        <!-- 处长id     		处长页面列表所需条件     	map.put("viewRemark", "3");//局长不通过，处长通过。可见 -->
				and LEADER_ID = #{leaderId}
				and (LEAVE_STATUS_ID != '3' or VIEW_REMARK = '3')
			</if>
			<if test="chairmanId != null">      <!-- 局长id 			局长页面列表所需条件 -->
				and CHAIRMAN_ID = #{chairmanId}
			</if>	
			<if test="status != null and status.length >0">
			and status in
			<foreach item="item" collection="status" open="(" separator="," close=")">
			#{item}
			</foreach>
			</if>
			<if test="leaveIds != null and leaveIds.length >0">
			and id in
			<foreach item="item" collection="leaveIds" open="(" separator="," close=")">
			#{item}</foreach>
			</if>
	</select>
	 
	<insert id="save" parameterType="com.css.app.qxjgl.business.entity.Leaveorback">
		insert into QXJ_LEAVEORBACK
		(
			"ID", 
			"APPLICATION_DATE", 
			"REGISTRATION_DATE", 
			"PROPOSER", 
			"VACATION_SORT_ID", 
			"VOCATION_PLACE", 
			"PLAN_TIME_START", 
			"PLAN_TIME_END", 
			"ACTUAL_TIME_START", 
			"ACTUAL_TIME_END", 
			"LEAVE_STATUS_ID", 
			"BACK_STATUS_ID", 
			"LEAVE_REMARK", 
			"LEADER_NAME", 
			"LEADER_ID", 
			"CHAIRMAN_NAME", 
			"CHAIRMAN_ID", 
			"LEADER_LEAVE_VIEW", 
			"LEADER_BACK_VIEW", 
			"CHAIRMAN_VIEW", 
			"VIEW_REMARK", 
			"DELETE_MARK", 
			"ACTUAL_VOCATION_DATE",
			"LEAVE_DAYS",
			"MOBILE",
			"PLACE",
			"org_id",
			"org_name",
			"vehicle",
			"turn_over",
			"status",
			"creator_id", 
			"creator", 
			"modificator",
			"modificator_id",
			"modify_date",
			"create_date",
			"ofd_file_id",
			"ORIGIN",
			"HOLIDAYNUM",
			"WEEKENDNUM",
			"DEPT_DUTY",
			"LINK_MAN",
			"UNDERTAKER",
			"UNDERTAKER_MOBILE",
			"UNDERTAKER_ID",
			"PARENT_ORG_ID"
		)
		values
		(
			#{id}, 
			#{applicationDate}, 
			#{registrationDate}, 
			#{proposer}, 
			#{vacationSortId}, 
			#{vocationPlace}, 
			#{planTimeStart}, 
			#{planTimeEnd}, 
			#{actualTimeStart}, 
			#{actualTimeEnd}, 
			#{leaveStatusId}, 
			#{backStatusId}, 
			#{leaveRemark}, 
			#{leaderName}, 
			#{leaderId}, 
			#{chairmanName}, 
			#{chairmanId}, 
			#{leaderLeaveView}, 
			#{leaderBackView}, 
			#{chairmanView}, 
			#{viewRemark}, 
			#{deleteMark}, 
			#{actualVocationDate},
			#{leaveDays},
			#{mobile},
			#{place},
			#{orgId},
			#{orgName},
			#{vehicle},
			#{turnOver},
			#{status},
			#{creatorId}, 
			#{creator}, 
			#{modificator},
			#{modificatorId},
			#{modifyDate},
			#{createDate},
			#{ofdFileId},
			#{origin},
			#{holidayNum},
			#{weekendNum},
			#{deptDuty},
			#{linkMan},
			#{undertaker},
			#{undertakerMobile},
			#{undertakerId},
			#{parentOrgId}
		)
	</insert>
	<update id="update" parameterType="com.css.app.qxjgl.business.entity.Leaveorback">
		update QXJ_LEAVEORBACK 
		<set>
			<if test="applicationDate != null">"APPLICATION_DATE" = #{applicationDate}, </if>
			<if test="registrationDate != null">"REGISTRATION_DATE" = #{registrationDate}, </if>
			<if test="proposer != null">"PROPOSER" = #{proposer}, </if>
			<if test="vacationSortId != null">"VACATION_SORT_ID" = #{vacationSortId}, </if>
			<if test="vocationPlace != null">"VOCATION_PLACE" = #{vocationPlace}, </if>
			<if test="planTimeStart != null">"PLAN_TIME_START" = #{planTimeStart}, </if>
			<if test="planTimeEnd != null">"PLAN_TIME_END" = #{planTimeEnd}, </if>
			<if test="actualTimeStart != null">"ACTUAL_TIME_START" = #{actualTimeStart}, </if>
			<if test="actualTimeEnd != null">"ACTUAL_TIME_END" = #{actualTimeEnd}, </if>
			<if test="leaveStatusId != null">"LEAVE_STATUS_ID" = #{leaveStatusId}, </if>
			<if test="backStatusId != null">"BACK_STATUS_ID" = #{backStatusId}, </if>
			<if test="leaveRemark != null">"LEAVE_REMARK" = #{leaveRemark}, </if>
			<if test="leaderName != null">"LEADER_NAME" = #{leaderName}, </if>
			<if test="leaderId != null">"LEADER_ID" = #{leaderId}, </if>
			<if test="chairmanName != null">"CHAIRMAN_NAME" = #{chairmanName}, </if>
			<if test="chairmanId != null">"CHAIRMAN_ID" = #{chairmanId}, </if>
			<if test="leaderLeaveView != null">"LEADER_LEAVE_VIEW" = #{leaderLeaveView}, </if>
			<if test="leaderBackView != null">"LEADER_BACK_VIEW" = #{leaderBackView}, </if>
			<if test="chairmanView != null">"CHAIRMAN_VIEW" = #{chairmanView}, </if>
			<if test="viewRemark != null">"VIEW_REMARK" = #{viewRemark}, </if>
			<if test="deleteMark != null">"DELETE_MARK" = #{deleteMark}, </if>
			<if test="actualVocationDate != null">"ACTUAL_VOCATION_DATE" = #{actualVocationDate},</if>
			<if test="mobile != null">"MOBILE" = #{mobile}, </if>
			<if test="place != null">"PLACE" = #{place}, </if>
			<if test="orgId != null">"org_id" = #{orgId}, </if>
			<if test="orgName != null">"org_name" = #{orgName}, </if>
			<if test="vehicle != null">"vehicle" = #{vehicle}, </if>
			<if test="turnOver != null">"turn_over" = #{turnOver}, </if>
			<if test="status != null">"status" = #{status}, </if>
			<if test="ofdFileId != null">"ofd_file_id" = #{ofdFileId}, </if>
			<if test="origin != null">"ORIGIN" = #{origin},</if>
			<if test="isView != null">"ISVIEW" = #{isView},</if>
			<if test="holidayNum != null">"holidayNum" = #{holidayNum},</if>
			<if test="weekendNum != null">"weekendNum" = #{weekendNum},</if>
			<if test="leaveDays != null">"LEAVE_DAYS" = #{leaveDays},</if>
			<if test="deptDuty != null">"DEPT_DUTY" = #{deptDuty},</if>
			<if test="linkMan != null">"LINK_MAN" = #{linkMan},</if>
			<if test="undertaker != null">"UNDERTAKER" = #{undertaker},</if>
			<if test="undertakerMobile != null">"UNDERTAKER_MOBILE" = #{undertakerMobile},</if>
			<if test="undertakerId != null">"UNDERTAKER_ID" = #{undertakerId},</if>
			<if test="parentOrgId != null">"PARENT_ORG_ID" = #{parentOrgId} </if>
		</set>
		where ID = #{id}
	</update>
	
	<delete id="delete">
		delete from QXJ_LEAVEORBACK where ID = #{value}
	</delete>
	
	<delete id="deleteBatch">
		delete from QXJ_LEAVEORBACK where ID in 
		<foreach item="id" collection="array" open="(" separator="," close=")">
			#{id}
		</foreach>
	</delete>
	
	<select id="queryBelongOrg" parameterType="java.lang.String" resultType="com.css.addbase.apporgan.entity.BaseAppOrgan" >
		SELECT * from BASE_APP_ORGAN a start with a.ID=#{id} and ISDELETE=0 connect by prior a.ID=a.PARENT_ID			
	</select>
	
	<select id="getQXJDefaultParam" resultType="com.css.app.qxjgl.business.entity.Leaveorback">
		select  
		dept_duty deptDuty ,
		link_man  linkMan , 
		mobile   
		from QXJ_LEAVEORBACK 
		where 
		delete_mark like '%' || #{userId} || '%' order by create_date desc limit 1
	</select>
	
	<select id="queryDeducttonDays" resultType="com.css.app.qxjgl.business.entity.Leaveorback">
		select * from (
		select
			IFNULL(DECODE(ACTUAL_VOCATION_DATE, NULL , LEAVE_DAYS, ACTUAL_VOCATION_DATE), 0) REST_DAYS,
			IFNULL(ACTUAL_TIME_START, PLAN_TIME_START)  START_TIME,
			IFNULL(ACTUAL_TIME_END, PLAN_TIME_END) END_TIME
		from QXJ_LEAVEORBACK
		where
		 vacation_sort_id in
    	(select id from QXJ_DIC_VOCATION_SORT WHERE ORG_ID = #{orgId} and DEDUCTION_VACATION_DAY = '0') 
				and DELETE_MARK like '%' || #{userId} || '%'
				and status = '30'
		)
		where
		   <![CDATA[
	    	END_TIME >= to_date(#{newYearStartDate},'yyyy-mm-dd')
	    	and START_TIME <= to_date(#{newYearEndDate},'yyyy-mm-dd')]]>
	</select>

</mapper>